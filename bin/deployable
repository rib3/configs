#!/usr/bin/env python

# Script to get pull-request id for current branch
# Requires `github_token` command (not provided)

from cmdutils import *
import re

def main():
    query = { 'state': 'open', 'sort': 'updated_at', 'direction': 'desc' }
    data = pulls(repo_path(), query)
    data.reverse() # Sidestep complexity of using direction: asc with unknown number of pages
    for pr in data:
        tickets = ticket_ids(pr.get('body'))
        if tickets:
            print "{number:5}  {ref:60} {tickets}".format(ref=pr['head']['ref'], tickets=' '.join(tickets), **pr)

def ticket_ids(s):
    # Simple, but seems to work ok
    return set(re.findall('[A-Z]+-\d+', s))

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print e
