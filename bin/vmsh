#!/usr/bin/env bash

set -e

function start-vm {
  if ! prlctl status "${1}" | grep -q "\brunning\b"; then
    prlctl start "${1}"
  else
    echo "already running"
  fi
}

function wait-for-ssh {
  echo -n "waiting for ssh"
  while ! ssh -o BatchMode=yes -o ConnectTimeout=5 "${1}" echo &> /dev/null;
  do
    echo -n "."
    sleep 1 # avoid aggressive retry on "fast" failures
  done
  echo " UP"
}

start-vm "${1}"
wait-for-ssh "${1}"
exec ssh "${1}"
