#!/bin/bash
set -e

# create and/or update a python virtualenv

VENV_DIR='venv'
PY_VERSION='python3.5'
REQUIREMENTS_BASE='requirements-base.txt'
REQUIREMENTS_FREEZE='requirements.txt'

if [ "$1" == "base" ]; then
  echo "using base requirements"
  REQUIREMENTS="${REQUIREMENTS_BASE}"
else
  REQUIREMENTS="${REQUIREMENTS_FREEZE}"
fi

if [ ! -f "${REQUIREMENTS}" ]; then
  (>&2 echo "missing requirements file: ${REQUIREMENTS}")
  exit 1
fi

echo "checking virtualenv: ${VENV_DIR}"
test -d "${VENV_DIR}" || virtualenv "${VENV_DIR}" -p "${PY_VERSION}" --no-site-packages

echo "requirements file: ${REQUIREMENTS}"
"${VENV_DIR}/bin/pip" install -r "${REQUIREMENTS}"

echo "freezing to: ${REQUIREMENTS}"
"${VENV_DIR}/bin/pip" freeze > "${REQUIREMENTS_FREEZE}"
