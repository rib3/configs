#!/usr/bin/env python
#
# Runs stage-up process using:
# git-pull-request-id - (from this repo)
# opsicle - http://github.com/sportngin/opsicle
# soyuz - http://github.com/sportngin/soyuz

from subprocess import check_call, check_output
import sys
import re

def die(msg):
    if msg:
        print msg
    sys.exit(1)

def confirm(cmd):
    # using raw_input for now...
    answer = raw_input("run: {} [y/N] ".format(' '.join(cmd)))
    if re.match('^[yY]', answer):
        check_call(cmd)
        return True

def get_pull_request():
    pr = check_output(['git', 'pull-request-id'])
    if not pr:
        die('No PR found.')
    return pr

def check_unpushed():
    unpushed = check_output(['git', 'cherry'])
    if unpushed:
        pushed = confirm(['git', 'push'])
        if not pushed:
            die("Can't continue with unpushed commits")

def main():
    pr = get_pull_request()
    check_unpushed()
    check_call(['op', 'stage-up', pr])
    confirm(['opsicle', 'monitor', 'staging'])
    confirm(['soyuz', 'deploy'])

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print e
