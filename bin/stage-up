#!/usr/bin/env python
#
# Runs stage-up process using:
# git-pull-request-id - (from this repo)
# opsicle - http://github.com/sportngin/opsicle
# soyuz - http://github.com/sportngin/soyuz

from subprocess import check_call, check_output
from miscutils import *

@validate('No PR found.')
def get_pull_request():
    return strip_output(['git', 'pull-request-id'])

def check_unpushed():
    unpushed = check_output(['git', 'cherry'])
    if unpushed:
        print('Unstaged commits')
        pushed = confirm(['git', 'push'])
        if not pushed:
            die("Can't continue with unpushed commits")

def main():
    pr = get_pull_request()
    check_unpushed()
    check_call(['op', 'stage-up', pr])
    check_call(['opsicle', 'monitor', 'staging'])
    confirm(['soyuz', 'deploy', 'staging'])

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print e
