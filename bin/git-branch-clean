#!/bin/bash
set -e

merged_target="${1-origin/master}"

git fetch

branches=$(git branch --merged "${merged_target}" | grep -v "^\*")
echo "${branches}" | while read branch; do
    branch_full_name=$(git rev-parse --symbolic-full-name "${branch}")
    branch_upstream=$(git for-each-ref --format='%(upstream:short)' "${branch_full_name}")
    if [ "${branch_upstream}" != "${merged_target}" ]; then
        git branch -d "${branch}"
    fi
done
